---
title: "Pulmonary Impairment in HIV-infected South African Adults"
subtitle: "Data exploration"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE
)
```

Load the packages:

```{r}
library(tidyverse)
library(here)
library(Hmisc)
library(gtsummary)
library(naniar)
library(ggExtra)
library(patchwork)
library(gridExtra)
library(rpart)
library(rpart.plot)
theme_set(theme_bw(12))
```

Import the dataset:

```{r}
p_hiv <- read_rds(here("case_studies", "pi_hiv", "pi_hiv_data.rds"))
```

# Baseline data description
Select the baseline dataset:

```{r}
bs_d <- p_hiv |> 
  dplyr::filter(visit == 0)
```

Let's have a very rough overview of the baseline dataset:

```{r, fig.height = 8, fig.width = 6}
plot(describe(
  bs_d |> 
    dplyr::select(-c(ptid, visit)),
  exclude.missing = FALSE
))
```

Some summary statistics on the dataset:

```{r}
labels <- list(
  age ~ "Age (years)",
  ca_sex ~ "Sex",
  ca_smk ~ "Smoking status",
  ca_hadtb ~ "History of tuberculosis",
  bmi ~ "BMI (kg/m^2)",
  ca_art ~ "Has the subject ever been on ART?",
  crp ~ "CRP (mg/L)",
  vl ~ "Viral loads (copies/mL)",
  vl_dl ~ "Viral loads DL",
  ce_prefev1 ~ "FEV1 (L)",
  ce_prefvc ~ "FVC (L)",
  ce_prefev1_fvc ~ "FEV1/FVC"
)

bs_d |> 
  dplyr::select(-c(ptid, visit)) |> 
  tbl_summary(
    label = labels,
    statistic = list(
      all_continuous() ~ "[{p10}; {p25}; {median}; {p75}; {p90}] - {mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    missing = "always",
    missing_text = "(Missing)"
  )
```

Look at the bivariate distributions of FEV1 and FVC:

```{r, fig.height = 8, fig.width = 8}
scatter_p <- ggplot(
  data = bs_d,
  mapping = aes(x = ce_prefev1, y = ce_prefvc)
) +
  geom_point() +
  geom_smooth(color = "red") +
  xlab("FEV1 (L)") +
  ylab("FVC (L)")

ggMarginal(scatter_p, type = "histogram", bins = 75L)
```

As expected, the correlation between the spirometry parameters is
very strong and can be considered as linear. Moreover, both
parameters have marginal distributions that can be reasonably
approximated as gaussians.

Explore the association between FEV1 and FVC and ART users:

```{r, fig.height = 8, fig.width = 8}
scatter_p <- ggplot(
  data = bs_d,
  mapping = aes(x = ce_prefev1, y = ce_prefvc, colour = ca_art)
) +
  geom_point() +
  xlab("FEV1 (L)") +
  ylab("FVC (L)") +
  theme(legend.position = "bottom")

ggMarginal(scatter_p, type = "histogram", bins = 75L, groupFill = TRUE)
```

Distributions look homogeneous between groups.

Same for viral loads, CD4 cell counts, BMI, and CRP, which are categorized
at clinically relevant values as described in [Gupte et al. (2017)](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0184530).

```{r, fig.height = 10, fig.width = 10}
bs_d_cat <- bs_d |> 
  mutate(
    bmi_cat = cut(
      bmi, 
      breaks = c(-Inf, 18.5, 25, Inf),
      ordered_result = TRUE
    ),
    crp_cat = cut(
      crp, 
      breaks = c(-Inf, 1, 3, 9, Inf),
      ordered_result = TRUE
    ),
    vl_cat = cut(
      vl, 
      breaks = c(-Inf, 50, 2655, 13548, Inf),
      ordered_result = TRUE
    ),
    cd4_cat = cut(
      cd4, 
      breaks = c(-Inf, 200, 350, 500, Inf),
      ordered_result = TRUE
    )
  )

scatter_p <- ggplot(
  data = bs_d_cat,
  mapping = aes(x = ce_prefev1, y = ce_prefvc, colour = bmi_cat)
) +
  geom_point() +
  xlab("FEV1 (L)") +
  ylab("FVC (L)") +
  theme(legend.position = "bottom")

p_bmi <- ggMarginal(
  scatter_p, type = "histogram", bins = 75L, groupFill = TRUE
)

scatter_p <- ggplot(
  data = bs_d_cat,
  mapping = aes(x = ce_prefev1, y = ce_prefvc, colour = crp_cat)
) +
  geom_point() +
  xlab("FEV1 (L)") +
  ylab("FVC (L)") +
  theme(legend.position = "bottom")

p_crp <- ggMarginal(
  scatter_p, type = "histogram", bins = 75L, groupFill = TRUE
)

scatter_p <- ggplot(
  data = bs_d_cat,
  mapping = aes(x = ce_prefev1, y = ce_prefvc, colour = vl_cat)
) +
  geom_point() +
  xlab("FEV1 (L)") +
  ylab("FVC (L)") +
  theme(legend.position = "bottom")

p_vl <- ggMarginal(
  scatter_p, type = "histogram", bins = 75L, groupFill = TRUE
)

scatter_p <- ggplot(
  data = bs_d_cat,
  mapping = aes(x = ce_prefev1, y = ce_prefvc, colour = cd4_cat)
) +
  geom_point() +
  xlab("FEV1 (L)") +
  ylab("FVC (L)") +
  theme(legend.position = "bottom")

p_cd4 <- ggMarginal(
  scatter_p, type = "histogram", bins = 75L, groupFill = TRUE
)

grid.arrange(p_bmi, p_crp, p_vl, p_cd4, ncol = 2L, nrow = 2L)
```

Quick exploration of missing data:

```{r, fig.width = 10, fig.height = 10}
bs_d_miss <- bs_d |> 
  dplyr::select(-c(ptid, visit, ce_prefev1_fvc)) |> 
  add_prop_miss()

rpart(
  prop_miss_all ~ ., 
  data = bs_d_miss,
  control = rpart.control(minsplit = 50L)
) |> 
  prp(type = 4, extra = 101, prefix = "Prop. Miss = ")
```

The overall $\%$ of missingness is low, i.e., around $3 \%$. In 
addition to that, the proportion of missingness seems to be reasonably
explained by variables included in the dataset. 

# Follow-up data description
Look at the summary statistics of variables measured over the
follow-up:

```{r}
labels <- list(
  bmi ~ "BMI (kg/m^2)",
  crp ~ "CRP (mg/L)",
  vl ~ "Viral loads (copies/mL)",
  vl_dl ~ "Viral loads DL",
  ce_prefev1 ~ "FEV1 (L)",
  ce_prefvc ~ "FVC (L)",
  ce_prefev1_fvc ~ "FEV1/FVC"
)

p_hiv |> 
  dplyr::select(
    visit, bmi, crp, cd4, vl, vl_dl, ce_prefev1,
    ce_prefvc, ce_prefev1_fvc
  ) |> 
  tbl_summary(
    label = labels,
    by = "visit",
    statistic = list(
      all_continuous() ~ "[{p25}; {median}; {p75}] - {mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    missing = "always",
    missing_text = "(Missing)"
  )
```

Plot the distribution of FEV1, FVC, and their ratio over the follow-up:

```{r, fig.height = 10, fig.width = 12}
d_plot_spir <- p_hiv |> 
  dplyr::select(visit, ce_prefev1, ce_prefvc, ce_prefev1_fvc) |> 
  dplyr::filter(visit %in% c(0, 12, 24, 36))

p_fev1 <- d_plot_spir |> 
  ggplot(mapping = aes(x = visit, y = ce_prefev1)) +
  geom_smooth(colour = "red", method = "lm") +
  geom_violin(alpha = 0.5, aes(group = visit)) +
  geom_point(position = position_jitter(width = 0.5)) +
  scale_x_continuous(breaks = c(0, 12, 24, 36)) +
  xlab("Follow-up visit (6 months)") +
  ylab("FEV1 (L)")

p_fvc <- d_plot_spir |> 
  ggplot(mapping = aes(x = visit, y = ce_prefvc)) +
  geom_smooth(colour = "red", method = "lm") +
  geom_violin(alpha = 0.5, aes(group = visit)) +
  geom_point(position = position_jitter(width = 0.5)) +
  scale_x_continuous(breaks = c(0, 12, 24, 36)) +
  xlab("Follow-up visit (6 months)") +
  ylab("FVC (L)")

p_fev1_fvc <- d_plot_spir |> 
  ggplot(mapping = aes(x = visit, y = ce_prefev1_fvc)) +
  geom_smooth(colour = "red", method = "lm") +
  geom_violin(alpha = 0.5, aes(group = visit)) +
  geom_point(position = position_jitter(width = 0.5)) +
  scale_x_continuous(breaks = c(0, 12, 24, 36)) +
  xlab("Follow-up visit (6 months)") +
  ylab("FEV1/FVC")

(p_fev1 | p_fvc) / p_fev1_fvc
```

For FEV1 and FVC, there is sligth evidence of a decreasing trend
over the follow-up time. However, for both parameters, the variability
of the data points decreases at the end of the 3 years follow-up.
The trend is the opposite for the ratio of the parameters and
the variability is reduced at the last follow-up visit.

Same for CRP, CD4 cell counts, and viral loads:

```{r, fig.height = 10, fig.width = 12}
d_plot_parm <- p_hiv |> 
  dplyr::select(visit, crp, cd4, vl) |> 
  dplyr::filter(visit %in% c(0, 6, 12, 18, 24, 30, 36))

p_crp <- d_plot_parm |> 
  ggplot(mapping = aes(x = visit, y = crp)) +
  geom_smooth(colour = "red", method = "lm") +
  geom_violin(alpha = 0.5, aes(group = visit)) +
  geom_point(position = position_jitter(width = 0.5)) +
  scale_x_continuous(breaks = c(0, 6, 12, 18, 24, 30, 36)) +
  xlab("Follow-up visit (6 months)") +
  ylab("CRP (mg/L)")

p_cd4 <- d_plot_parm |> 
  ggplot(mapping = aes(x = visit, y = cd4)) +
  geom_smooth(colour = "red", method = "lm") +
  geom_violin(alpha = 0.5, aes(group = visit)) +
  geom_point(position = position_jitter(width = 0.5)) +
  scale_x_continuous(breaks = c(0, 6, 12, 18, 24, 30, 36)) +
  xlab("Follow-up visit (6 months)") +
  ylab("CD4 cell counts (cells/mm^3)")

p_vl <- d_plot_parm |> 
  ggplot(mapping = aes(x = visit, y = vl)) +
  geom_smooth(colour = "red", method = "lm") +
  geom_violin(alpha = 0.5, aes(group = visit)) +
  geom_point(position = position_jitter(width = 0.5)) +
  scale_x_continuous(breaks = c(0, 6, 12, 18, 24, 30, 36)) +
  xlab("Follow-up visit (6 months)") +
  ylab("Viral loads (copies/mL)")

(p_cd4 | p_vl) / p_crp
```

The distribution of CD4 cell counts has progressively shifted to
higher values over the follow-up time. Overall, the amount of detected
viral loads decreases over the follow-up and higher observations
below the DL are observed. There is not clear trend for CRP, even
though the variability is reduced at the end of the follow-up.

# Prepare the datasets
Two datasets are now prepared:

1. a dataset in the long format for the analysis of the follow-up data.
   This dataset will have a row for each year of follow-up. Variables
   with baseline measurements for each parameters will be added. 
   Moreover, for the variables measured every 6 months, additional
   variables will be created to account for the data collected 6
   months prior the follow-up visit.
   
2. a dataset in the wide format with a column for each variable. This
   dataset will be mainly used for imputing missing data.

Dataset in the long format:

```{r}
d_long <- p_hiv |> 
  # Create baseline variables
  group_by(ptid) |> 
  mutate(
    across(
      c(bmi, crp:ce_prefev1_fvc),
      ~ dplyr::first(.x),
      .names = "{str_c(col, '_0m')}"
    )
  ) |>
  # Parameters every 6 months
  mutate(
    across(
      c(bmi, crp:vl_dl),
      ~ dplyr::lag(.x),
      .names = "{str_c(col, '_6m')}"
    )
  ) |> 
  # Take one row for each follow-up year
  dplyr::filter(visit %in% c(12, 24, 36)) |> 
  dplyr::select(
    ptid:ca_hadtb, 
    ca_art,
    bmi_0m, bmi_6m, bmi,
    crp_0m, crp_6m, crp,
    vl_0m, vl_6m, vl,
    vl_dl_0m, vl_dl_6m, vl_dl,
    cd4_0m, cd4_6m, cd4,
    ce_prefev1_0m, ce_prefev1,
    ce_prefvc_0m, ce_prefvc,
    ce_prefev1_fvc_0m, ce_prefev1_fvc
  )

write_rds(
  d_long,
  here::here("case_studies", "pi_hiv", "pi_hiv_data_long.rds")
)
```

Dataset in the wide format:

```{r}
d_wide <- p_hiv |> 
  mutate(
    visit = case_when(
      visit == 0 ~ "0m",
      visit == 6 ~ "6m",
      visit == 12 ~ "12m",
      visit == 18 ~ "18m",
      visit == 24 ~ "24m",
      visit == 30 ~ "30m",
      visit == 36 ~ "36m",
    ),
    vl_dl = if_else(vl_dl == "below LD", 1, 0)
  ) |> 
  pivot_longer(
    cols = c(bmi, crp:ce_prefev1_fvc),
    names_to = "parm", values_to = "values"
  ) |> 
  unite("vars", c(parm, visit), sep = "_") |> 
  pivot_wider(names_from = vars, values_from = values) |> 
  # Select final columns
  dplyr::select(
    ptid:vl_dl_6m,
    bmi_12m:vl_dl_18m,
    bmi_24m:vl_dl_30m,
    bmi_36m:ce_prefev1_fvc_36m
  )

write_rds(
  d_wide,
  here::here("case_studies", "pi_hiv", "pi_hiv_data_wide.rds")
)
```


# Session Info

```{r}
si <- sessionInfo()
print(si, locale = FALSE)
```


