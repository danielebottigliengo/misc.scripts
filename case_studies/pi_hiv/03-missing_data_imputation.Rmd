---
title: "Pulmonary Impairment in HIV-infected South African Adults"
subtitle: "Missing data imputation"
date: "`r Sys.Date()`"
bibliography: p_hiv_missing_bib.bib
link-citations: true
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: readable
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  warning = FALSE,
  message = FALSE,
  echo = TRUE
)
```

Load the packages:

```{r}
library(tidyverse)
library(here)
library(mice)
library(miceadds)
n_cores <- parallel::detectCores() - 1
theme_set(theme_bw(12))
seed <- 280191
set.seed(seed)
```

Import the datasets in the wide and long formats:

```{r}
long <- read_rds(here("case_studies", "pi_hiv", "pi_hiv_data_long.rds"))
wide <- read_rds(here("case_studies", "pi_hiv", "pi_hiv_data_wide.rds"))
```

# Missing data imputation strategy
Multiple imputation (MI) with a chained equations approach is used
to impute missing values [@van_buuren_2006]. With this approach, a
regression model is specified for each variable in the dataset. Missing
values are imputed by regression models for each variable conditional
on all the other variables in the dataset.

Here, we use the fully conditional specification (FCS) chained equations
approach as implemented in the `mice` R package  [@van_buuren_2018]. 
The Random Forest (RF) algorithm is used to specify regression models
for imputing missing values in all the variables in the dataset. This
choice is motivated by the fact that the RF easily allows to account for
non-linearities and interactions between and among the variables.
Missing data are imputed in the dataset in the wide format and, for
each variable, a regression model with all the remaining variables
as covariates is specified. Overall, $50$ imputed datasets are generated.

# Missing data imputation
The following chunk of code is used to multiply impute missing data:

```{r}
# Remove the variables that identifies VL below the LOD 
data_to_imp <- wide |> 
  dplyr::select(
    -c(
      vl_dl_0m, vl_dl_6m, vl_dl_12m, vl_dl_18m, vl_dl_24m, vl_dl_30m, 
      vl_dl_36m, ce_prefev1_fvc_0m, ce_prefev1_fvc_12m,
      ce_prefev1_fvc_24m, ce_prefev1_fvc_36m
    )
  )

# Define the imputation regression models ------------------------------
imp_models <- c(
  rep("", 6L), # id, age, sex, smoking, TB, ART
  rep("rf", ncol(data_to_imp) - 6)
)

# Define the predictor matrix ------------------------------------------
pred_mat <- make.predictorMatrix(data_to_imp)

# Don't use the subject ID as covariate in the imputation models
pred_mat[, c("ptid")] <- 0

# Run the MICE algorithm -----------------------------------------------
n_imp <- 30L
n_iter <- 30L
mice_obj <- futuremice(
  data = data_to_imp,
  m = n_imp,
  method = imp_models,
  predictorMatrix = pred_mat,
  visitSequence = "monotone",
  maxit = n_iter,
  parallelseed = seed,
  n.core = n_cores,
  n.imp.core = n_imp/n_cores,
  future.plan = "multisession",
  ntree = 100L,
  .progress = TRUE
)

# Save the object for future use
readr::write_rds(
  x = mice_obj,
  file = here::here("case_studies", "pi_hiv", "mice_obj.rds")
)
```


# Checking imputed data
Check the convergence of the imputation algorithm

```{r}
Rhat.mice(mice_obj)
```

```{r, fig.width = 8, fig.height = 6}
plot(mice_obj)
```

No convergence issues are flagged.

Check the distribution of imputed against observed data. Baseline
measurements:

```{r, fig.width = 8, fig.height = 6}
densityplot(
  mice_obj, 
  ~ bmi_0m + crp_0m + cd4_0m + vl_0m + ce_prefev1_0m + ce_prefvc_0m
)
```

At 6 months:

```{r, fig.width = 8, fig.height = 6}
densityplot(
  mice_obj, 
  ~ bmi_6m + crp_6m + cd4_6m + vl_6m
)
```

At 12 months:

```{r, fig.width = 8, fig.height = 6}
densityplot(
  mice_obj, 
  ~ bmi_12m + crp_12m + cd4_12m + vl_12m + ce_prefev1_12m + ce_prefvc_12m
)
```

At 18 months:

```{r, fig.width = 8, fig.height = 6}
densityplot(
  mice_obj, 
  ~ bmi_18m + crp_18m + cd4_18m + vl_18m
)
```

At 24 months:

```{r, fig.width = 8, fig.height = 6}
densityplot(
  mice_obj, 
  ~ bmi_24m + crp_24m + cd4_24m + vl_24m + ce_prefev1_24m + ce_prefvc_24m
)
```

At 30 months:

```{r, fig.width = 8, fig.height = 6}
densityplot(
  mice_obj, 
  ~ bmi_30m + crp_30m + cd4_30m + vl_30m
)
```

At 36 months:

```{r, fig.width = 8, fig.height = 6}
densityplot(
  mice_obj, 
  ~ bmi_36m + crp_36m + cd4_36m + vl_36m + ce_prefev1_36m + ce_prefvc_36m
)
```

The distributions of imputed data nicely resembled those of observed
data.

Reshape the imputed datasets in the long format and store them
into a `mids` object:

```{r}
imp_data <- complete(mice_obj, action = "all", include = TRUE) |> 
  imap(
    \(x, y) {
      
      # Baseline dataset
      bs <- x |> 
        dplyr::select(ptid:ce_prefvc_0m) |> 
        mutate(
          # Indicator of whether VL is below the LOD
          vl_dl_0m = factor(
            if_else(vl_0m == 49, "below LD", "above LD"),
            levels = c("above LD", "below LD")
          ),
          # FEV1/FVC
          ce_prefev1_fvc_0m = ce_prefev1_0m/ce_prefvc_0m
        )
      
      # 6, 18, 30 months measurements dataset
      six_m <- x |> 
        dplyr::select(
          ptid, bmi_6m:vl_6m, bmi_18m:vl_18m, bmi_30m:vl_30m
        ) |> 
        pivot_longer(-c(ptid), names_to = "vars", values_to = "vals") |> 
        separate(vars, c("pars", "visit"), sep = "_") |> 
        pivot_wider(names_from = pars, values_from = vals) |> 
        mutate(
          visit = as.integer(case_when(
            visit == "6m" ~ 12,
            visit == "18m" ~ 24,
            visit == "30m" ~ 36
          ))
        ) |> 
        rename_with(~ str_c(.x, "_6m"), bmi:vl) |> 
        # Indicator of whether VL is below the LOD
        mutate(
          vl_dl_6m = factor(
            if_else(vl_6m == 49, "below LD", "above LD"),
            levels = c("above LD", "below LD")
          )
        )
      
      # 12, 24, 36 months measurements dataset
      year_m <- x |> 
        dplyr::select(
          ptid, 
          bmi_12m:ce_prefvc_12m, 
          bmi_24m:ce_prefvc_24m,
          bmi_36m:ce_prefvc_36m
        ) |> 
        pivot_longer(-c(ptid), names_to = "vars", values_to = "vals") |> 
        mutate(
          pars = case_when(
            str_detect(vars, "bmi") ~ "bmi",
            str_detect(vars, "crp") ~ "crp",
            str_detect(vars, "cd4") ~ "cd4",
            str_detect(vars, "vl") ~ "vl",
            str_detect(vars, "ce_prefev1") ~ "ce_prefev1",
            str_detect(vars, "ce_prefvc") ~ "ce_prefvc"
          ),
          visit = as.integer(case_when(
            str_detect(vars, "12m") ~ 12,
            str_detect(vars, "24m") ~ 24,
            str_detect(vars, "36m") ~ 36
          ))
        ) |> 
        dplyr::select(-vars) |> 
        pivot_wider(names_from = pars, values_from = vals) |> 
        mutate(
          # Indicator of whether VL is below the LOD
          vl_dl = factor(
            if_else(vl == 49, "below LD", "above LD"),
            levels = c("above LD", "below LD")
          ),
          # FEV1/FVC
          ce_prefev1_fvc = ce_prefev1/ce_prefvc
        )
      
      # Join the datasets
      imp_long <- six_m |> 
        left_join(year_m, by = c("ptid", "visit")) |> 
        left_join(bs, by = "ptid") |> 
        rowid_to_column(var = ".id") |> 
        mutate(.imp = as.numeric(y), .before = 1L)
      
    }
  )

imp_data_mids <- as.mids(list_rbind(imp_data))
```

Save the imputed datasets:

```{r}
readr::write_rds(
  x = imp_data_mids,
  file = here::here("case_studies", "pi_hiv", "imp_datasets.rds")
)
```


# Session Info

```{r}
si <- sessionInfo()
print(si, locale = FALSE)
```

# References

